<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Config Pro Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-500 mb-2">ØªØ³ØªØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§Ø¨Ù„ÛŒÙ†Ú©</h1>
            <div id="statsBar" class="flex justify-center gap-4 mt-4 text-sm">
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700">Ú©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§: <b id="totalCount" class="text-blue-400">0</b></span>
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700">ØªØ³Øª Ø´Ø¯Ù‡: <b id="testedCount" class="text-yellow-400">0</b></span>
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 text-emerald-400">Ø³Ø§Ù„Ù…: <b id="healthyCount">0</b></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-xl">
                    <label class="block text-sm font-medium mb-2 text-blue-300">ÙˆØ±ÙˆØ¯ÛŒ Ø³Ø§Ø¨Ù„ÛŒÙ†Ú©:</label>
                    <textarea id="subLinks" rows="6" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-[10px] md:text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none transition text-left" dir="ltr" placeholder="https://example.com/sub..."></textarea>
                    
                    <div class="mt-4 shadow-sm">
                        <label class="block text-xs text-gray-400 mb-1">Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒÙ†Ú¯ Ù…Ø¬Ø§Ø² (ms):</label>
                        <input type="number" id="pingLimit" value="800" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-center">
                    </div>

                    <button onclick="processSub()" id="btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">Ø´Ø±ÙˆØ¹ ØªØ³Øª Ùˆ ÙÛŒÙ„ØªØ±</button>
                    <button onclick="copyHealthyConfigs()" id="copyBtn" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-xl text-sm font-medium hidden">Ú©Ù¾ÛŒ Ù…ÙˆØ§Ø±Ø¯ Ø³Ø§Ù„Ù…</button>
                </div>
                <div id="statusInfo" class="text-center text-xs text-slate-500 animate-pulse"></div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl min-h-[300px]">
                    <div class="max-h-[600px] overflow-y-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-slate-700/50 sticky top-0 backdrop-blur-md text-gray-300 text-xs">
                                <tr>
                                    <th class="p-4">Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯ (Remark)</th>
                                    <th class="p-4 text-center">Ù¾ÛŒÙ†Ú¯</th>
                                    <th class="p-4 text-center">ÙˆØ¶Ø¹ÛŒØª</th>
                                </tr>
                            </thead>
                            <tbody id="resultTable" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="p-20 text-center text-gray-500 text-sm">Ù…Ù†ØªØ¸Ø± ÙˆØ±ÙˆØ¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¨...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let healthyConfigs = [];
        let totalFound = 0;
        let testedSoFar = 0;

        async function processSub() {
            const btn = document.getElementById('btn');
            const subInput = document.getElementById('subLinks').value.trim();
            const resultsBody = document.getElementById('resultTable');
            const statusInfo = document.getElementById('statusInfo');
            const pingLimit = parseInt(document.getElementById('pingLimit').value);
            
            if (!subInput) return alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù„ÛŒÙ†Ú© Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            
            // Reset UI
            btn.disabled = true;
            btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬...";
            resultsBody.innerHTML = "";
            healthyConfigs = [];
            totalFound = 0;
            testedSoFar = 0;
            updateStats();
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('copyBtn').classList.add('hidden');

            const links = subInput.split('\n').map(l => l.trim()).filter(l => l !== '');

            for (let subUrl of links) {
                try {
                    statusInfo.innerText = "Ø¯Ø±Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø­ØªÙˆØ§ Ø§Ø² Ø³Ø±ÙˆØ± ÙˆØ§Ø³Ø·...";
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÛŒÚ© Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ù…ØªÙØ§ÙˆØª Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¨ÛŒØ´ØªØ±
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(subUrl)}`);
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    
                    let content = data.contents.trim();
                    let decoded;

                    // Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ©ÙˆØ¯ Base64 Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                    try {
                        decoded = atob(content);
                    } catch (e) {
                        // Ø§Ú¯Ø± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯ÛŒÚ©ÙˆØ¯ Ù†Ø´Ø¯ØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ØµÙ„Ø§Ø­ ÙØ±Ù…Øª Ø¯Ø§Ø±Ø¯ ÛŒØ§ base64 Ù†ÛŒØ³Øª
                        try {
                            decoded = atob(content.replace(/-/g, '+').replace(/_/g, '/'));
                        } catch {
                            decoded = content; 
                        }
                    }

                    const configs = decoded.split(/\r?\n/).filter(c => c.includes('://'));
                    totalFound += configs.length;
                    updateStats();

                    for (let conf of configs) {
                        const parsed = parseConfig(conf);
                        if (parsed) {
                            const rowId = `row-${Math.random().toString(36).substr(2, 7)}`;
                            const row = resultsBody.insertRow();
                            row.id = rowId;
                            row.className = "hover:bg-slate-700/30 transition text-[11px] md:text-sm";
                            row.innerHTML = `
                                <td class="p-4 max-w-[150px] md:max-w-[250px] truncate font-medium text-slate-200">${parsed.name}</td>
                                <td class="p-4 text-center font-mono" id="ping-${rowId}">---</td>
                                <td class="p-4 text-center" id="status-${rowId}">â³</td>
                            `;
                            
                            performTest(parsed, rowId, conf, pingLimit);
                        } else {
                            testedSoFar++; // Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…ÙˆØ§Ø±Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                            updateStats();
                        }
                    }
                } catch (e) {
                    statusInfo.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø¨â€ŒÙ„ÛŒÙ†Ú©! (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù„ÛŒÙ†Ú© ÙÛŒÙ„ØªØ± Ø¨Ø§Ø´Ø¯)";
                    console.error(e);
                }
            }
            btn.disabled = false;
            btn.innerText = "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯";
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = totalFound;
            document.getElementById('testedCount').innerText = testedSoFar;
            document.getElementById('healthyCount').innerText = healthyConfigs.length;
        }

        function parseConfig(url) {
            try {
                let name = "Unknown", address = "";
                if (url.startsWith('vmess://')) {
                    const str = url.replace('vmess://', '');
                    const data = JSON.parse(atob(str));
                    name = data.ps; address = data.add;
                } else if (url.startsWith('vless://') || url.startsWith('trojan://') || url.startsWith('ss://')) {
                    const parts = new URL(url.split('#')[0]); // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø´
                    address = parts.hostname || parts.username; // Ø¯Ø± Ø¨Ø±Ø®ÛŒ ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø¢Ø¯Ø±Ø³ Ø¯Ø± ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø§Ø³Øª
                    name = decodeURIComponent(url.split('#')[1] || "Config");
                }
                if (!address) return null;
                return { name, address };
            } catch { return null; }
        }

        async function performTest(parsed, rowId, fullConfig, limit) {
            const start = Date.now();
            const pingCell = document.getElementById(`ping-${rowId}`);
            const statusCell = document.getElementById(`status-${rowId}`);
            const row = document.getElementById(rowId);

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 5000); // 5 Ø«Ø§Ù†ÛŒÙ‡ Ù…Ù‡Ù„Øª ØªØ³Øª

            try {
                // ØªØ³Øª Ù¾ÛŒÙ†Ú¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù¾ÙˆØ±Øª HTTPS (Ø¨Ø³ÛŒØ§Ø± Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±)
                await fetch(`https://${parsed.address}`, { mode: 'no-cors', signal: controller.signal, cache: 'no-cache' });
                const delta = Date.now() - start;
                clearTimeout(timeout);

                pingCell.innerText = delta + "ms";
                
                if (delta <= limit) {
                    pingCell.className = "p-4 text-center font-mono text-emerald-400 font-bold";
                    statusCell.innerText = "âœ…";
                    healthyConfigs.push(fullConfig);
                    document.getElementById('copyBtn').classList.remove('hidden');
                } else {
                    row.classList.add('opacity-40');
                    pingCell.className = "p-4 text-center font-mono text-amber-500";
                    statusCell.innerText = "ğŸ¢";
                }
            } catch {
                pingCell.innerText = "âŒ";
                pingCell.className = "p-4 text-center font-mono text-red-500";
                statusCell.innerText = "Ù‚Ø·Ø¹";
                row.classList.add('opacity-30');
            } finally {
                testedSoFar++;
                updateStats();
            }
        }

        function copyHealthyConfigs() {
            const text = healthyConfigs.join('\n');
            navigator.clipboard.writeText(text);
            const copyBtn = document.getElementById('copyBtn');
            const originalText = copyBtn.innerText;
            copyBtn.innerText = "âœ… Ú©Ù¾ÛŒ Ø´Ø¯!";
            setTimeout(() => { copyBtn.innerText = originalText; }, 2000);
        }
    </script>
</body>
</html>
