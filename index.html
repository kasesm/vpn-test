<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Tester - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
    </style>
</head>
<body class="p-5">
    <div class="max-w-4xl mx-auto">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl mb-6">
            <h1 class="text-xl font-bold mb-4 text-blue-400">تستر کانفیگ ساب‌لینک</h1>
            <textarea id="subLinks" rows="4" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-sm mb-4 outline-none focus:ring-2 focus:ring-blue-500" placeholder="لینک ساب را اینجا قرار دهید..."></textarea>
            
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label class="block text-xs text-gray-400 mb-1">فیلتر پینگ (ms):</label>
                    <input type="number" id="pingLimit" value="1000" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-center">
                </div>
                <div class="flex-1 flex items-end">
                    <button onclick="startProcessing()" id="btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold transition">شروع تست</button>
                </div>
            </div>

            <div id="stats" class="text-sm border-t border-slate-700 pt-4 flex justify-around text-gray-300">
                <span>یافت شده: <b id="totalCount" class="text-blue-400">0</b></span>
                <span>تست شده: <b id="testedCount" class="text-yellow-400">0</b></span>
                <span>سالم: <b id="healthyCount" class="text-green-400">0</b></span>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-xl">
            <table class="w-full text-right text-sm">
                <thead class="bg-slate-900 text-gray-400">
                    <tr>
                        <th class="p-3">نام کانفیگ</th>
                        <th class="p-3 text-center">پینگ</th>
                    </tr>
                </thead>
                <tbody id="resultTable"></tbody>
            </table>
        </div>
        <button onclick="copyAll()" id="copyBtn" class="w-full mt-4 bg-green-600 py-3 rounded-xl font-bold hidden">کپی کانفیگ‌های سالم</button>
    </div>

    <script>
        let healthyLinks = [];
        let total = 0;
        let tested = 0;

        async function startProcessing() {
            const subUrl = document.getElementById('subLinks').value.trim();
            const resultsBody = document.getElementById('resultTable');
            const btn = document.getElementById('btn');
            
            if (!subUrl) return alert("لطفاً لینک را وارد کنید");

            // Reset
            resultsBody.innerHTML = "";
            healthyLinks = [];
            total = 0;
            tested = 0;
            updateUI();
            btn.disabled = true;
            btn.innerText = "درحال دریافت...";

            try {
                // استفاده از پروکسی مستقیم و ساده‌تر
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(subUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                let rawContent = data.contents;

                // دیکود کردن محتوا
                let decoded = "";
                try {
                    decoded = atob(rawContent.trim());
                } catch {
                    decoded = rawContent;
                }

                const configs = decoded.split(/\r?\n/).filter(line => line.includes('://'));
                total = configs.length;
                updateUI();

                if(total === 0) alert("هیچ کانفیگی در این لینک پیدا نشد!");

                for (const conf of configs) {
                    await testConfig(conf);
                }

            } catch (err) {
                console.error(err);
                alert("خطا در دریافت اطلاعات. احتمالاً لینک اشتباه است یا پروکسی کار نمی‌کند.");
            } finally {
                btn.disabled = false;
                btn.innerText = "شروع تست";
                if(healthyLinks.length > 0) document.getElementById('copyBtn').classList.remove('hidden');
            }
        }

        async function testConfig(conf) {
            let address = "";
            let name = "بدون نام";

            try {
                if (conf.startsWith('vmess://')) {
                    const json = JSON.parse(atob(conf.replace('vmess://', '')));
                    address = json.add;
                    name = json.ps;
                } else {
                    const urlObj = new URL(conf);
                    address = urlObj.hostname;
                    name = decodeURIComponent(urlObj.hash.slice(1)) || "Unnamed";
                }

                const row = document.getElementById('resultTable').insertRow();
                const nameCell = row.insertCell(0);
                const pingCell = row.insertCell(1);
                nameCell.className = "p-3 border-b border-slate-700";
                pingCell.className = "p-3 border-b border-slate-700 text-center font-mono";
                nameCell.innerText = name;
                pingCell.innerText = "...";

                const start = Date.now();
                const limit = parseInt(document.getElementById('pingLimit').value);

                try {
                    // تست پینگ واقعی با fetch
                    await fetch(`https://${address}`, { mode: 'no-cors', cache: 'no-cache', signal: AbortSignal.timeout(3000) });
                    const duration = Date.now() - start;
                    pingCell.innerText = duration + "ms";
                    
                    if (duration <= limit) {
                        pingCell.className += " text-green-400 font-bold";
                        healthyLinks.push(conf);
                    } else {
                        pingCell.className += " text-yellow-500";
                    }
                } catch {
                    pingCell.innerText = "❌";
                    pingCell.className += " text-red-500";
                }
            } catch (e) {
                console.error("خطا در پارس کانفیگ", e);
            } finally {
                tested++;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('totalCount').innerText = total;
            document.getElementById('testedCount').innerText = tested;
            document.getElementById('healthyCount').innerText = healthyLinks.length;
        }

        function copyAll() {
            navigator.clipboard.writeText(healthyLinks.join('\n'));
            alert("کپی شد!");
        }
    </script>
</body>
</html>
