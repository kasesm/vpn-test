<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2Ray Turbo Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-4xl mx-auto">
        <div class="bg-slate-800 p-6 md:p-8 rounded-3xl border border-slate-700 shadow-2xl mb-8">
            <h1 class="text-2xl font-bold text-blue-400 mb-6 text-center">ØªØ³ØªØ± ÙÙˆÙ‚â€ŒØ³Ø±ÛŒØ¹ (ØªØ³Øª Ù…ÙˆØ§Ø²ÛŒ)</h1>
            
            <textarea id="subLinks" rows="4" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-4 text-sm mb-4 outline-none focus:ring-2 focus:ring-blue-500 font-mono" dir="ltr" placeholder="Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¨ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒÙ†Ú¯ Ù…Ø¬Ø§Ø²:</label>
                    <input type="number" id="pingLimit" value="1000" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-center font-bold text-emerald-400">
                </div>
                <div class="flex items-end">
                    <button onclick="startTurboTest()" id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all active:scale-95 shadow-lg">Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø³Ø±ÛŒØ¹</button>
                </div>
            </div>

            <div id="stats" class="grid grid-cols-3 gap-4 text-center bg-slate-900/80 p-5 rounded-2xl border border-slate-800">
                <div class="flex flex-col"><span class="text-slate-500 text-xs">Ú©Ù„</span><b id="total" class="text-blue-400 text-lg">0</b></div>
                <div class="flex flex-col"><span class="text-slate-500 text-xs">ØªØ³Øª Ø´Ø¯Ù‡</span><b id="tested" class="text-yellow-400 text-lg">0</b></div>
                <div class="flex flex-col"><span class="text-slate-500 text-xs">Ø³Ø§Ù„Ù…</span><b id="healthy" class="text-emerald-400 text-lg">0</b></div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden shadow-xl">
            <div class="max-h-[500px] overflow-y-auto custom-scroll">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-900 sticky top-0 z-10 text-slate-400 text-xs">
                        <tr>
                            <th class="p-4">Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯</th>
                            <th class="p-4 text-center">Ù¾ÛŒÙ†Ú¯</th>
                            <th class="p-4 text-center">ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                    </thead>
                    <tbody id="resultTable" class="divide-y divide-slate-700/50"></tbody>
                </table>
            </div>
        </div>

        <button onclick="copyAll()" id="copyBtn" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-bold hidden shadow-xl transition-all transform hover:-translate-y-1">Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø±Ø¹Øª</button>
    </div>

    <script>
        const PROXY_WORKER = "https://sub-proxy.task132141.workers.dev/";
        const CONCURRENCY_LIMIT = 15; // ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† (Ø³Ø±Ø¹Øª)

        let healthyConfigs = [];
        let testedCount = 0;
        let totalConfigs = 0;

        async function startTurboTest() {
            const subInput = document.getElementById('subLinks').value.trim();
            const btn = document.getElementById('mainBtn');
            const table = document.getElementById('resultTable');

            if (!subInput) return alert("Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

            btn.disabled = true;
            btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";
            table.innerHTML = "";
            healthyConfigs = [];
            testedCount = 0;
            updateUI(0, 0, 0);

            try {
                const subUrls = subInput.split('\n').filter(l => l.trim() !== '');
                let allConfigs = [];

                for (const sub of subUrls) {
                    const response = await fetch(`${PROXY_WORKER}?url=${encodeURIComponent(sub.trim())}`);
                    const rawData = await response.text();
                    let decoded = "";
                    try { decoded = atob(rawData.trim().replace(/_/g, '/').replace(/-/g, '+').replace(/\s/g, '')); } 
                    catch { decoded = rawData; }
                    
                    const found = decoded.split(/\r?\n/).filter(line => line.includes('://'));
                    allConfigs = [...allConfigs, ...found];
                }

                totalConfigs = allConfigs.length;
                updateUI(totalConfigs, 0, 0);

                // --- Ù…Ù†Ø·Ù‚ ØªØ³Øª Ù…ÙˆØ§Ø²ÛŒ (Turbo Mode) ---
                const queue = [...allConfigs];
                const workers = [];

                for (let i = 0; i < Math.min(CONCURRENCY_LIMIT, queue.length); i++) {
                    workers.push(worker(queue));
                }

                await Promise.all(workers);

            } catch (err) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯";
                if(healthyConfigs.length > 0) document.getElementById('copyBtn').classList.remove('hidden');
            }
        }

        async function worker(queue) {
            while (queue.length > 0) {
                const conf = queue.shift();
                await testConfig(conf);
            }
        }

        async function testConfig(conf) {
            let address = "", name = "Unnamed";
            try {
                if (conf.startsWith('vmess://')) {
                    const json = JSON.parse(atob(conf.replace('vmess://', '')));
                    address = json.add; name = json.ps;
                } else {
                    const parts = new URL(conf);
                    address = parts.hostname || parts.username;
                    name = decodeURIComponent(conf.split('#')[1] || "Config");
                }

                const row = document.getElementById('resultTable').insertRow(0); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù„ÛŒØ³Øª
                const nCell = row.insertCell(0);
                const pCell = row.insertCell(1);
                const sCell = row.insertCell(2);
                
                nCell.className = "p-4 text-slate-200 truncate max-w-[200px]";
                pCell.className = "p-4 text-center font-mono";
                sCell.className = "p-4 text-center";
                nCell.innerText = name;
                pCell.innerText = "...";

                const start = Date.now();
                try {
                    await fetch(`https://${address}`, { mode: 'no-cors', cache: 'no-cache', signal: AbortSignal.timeout(3000) });
                    const delay = Date.now() - start;
                    pCell.innerText = delay + " ms";
                    
                    if (delay <= parseInt(document.getElementById('pingLimit').value)) {
                        pCell.className += " text-emerald-400 font-bold";
                        sCell.innerText = "âœ…";
                        healthyConfigs.push(conf);
                    } else {
                        pCell.className += " text-amber-500";
                        sCell.innerText = "ğŸ¢";
                    }
                } catch {
                    pCell.innerText = "âŒ";
                    pCell.className += " text-red-500";
                    sCell.innerText = "Ù‚Ø·Ø¹";
                }
            } catch (e) { } 
            finally {
                testedCount++;
                updateUI(totalConfigs, testedCount, healthyConfigs.length);
            }
        }

        function updateUI(t, td, h) {
            document.getElementById('total').innerText = t;
            document.getElementById('tested').innerText = td;
            document.getElementById('healthy').innerText = h;
        }

        function copyAll() {
            navigator.clipboard.writeText(healthyConfigs.join('\n'));
            alert("Ú©Ù¾ÛŒ Ø´Ø¯!");
        }
    </script>
</body>
</html>
