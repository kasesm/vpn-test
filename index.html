<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Config Pro Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-blue-500 mb-2">ØªØ³ØªØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø³Ø§Ø¨Ù„ÛŒÙ†Ú©</h1>
            <p class="text-gray-400 text-sm">Ø§Ø³ØªØ®Ø±Ø§Ø¬ØŒ ØªØ³Øª Ù¾ÛŒÙ†Ú¯ Ùˆ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-xl">
                    <label class="block text-sm font-medium mb-2 text-blue-300">ÙˆØ±ÙˆØ¯ÛŒ Ø³Ø§Ø¨Ù„ÛŒÙ†Ú©:</label>
                    <textarea id="subLinks" rows="6" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-xs focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¨ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                    
                    <div class="mt-4 shadow-sm">
                        <label class="block text-xs text-gray-400 mb-1">Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒÙ†Ú¯ Ù…Ø¬Ø§Ø² (ms):</label>
                        <input type="number" id="pingLimit" value="500" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-center">
                    </div>

                    <button onclick="processSub()" id="btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all transform active:scale-95">Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ</button>
                    <button onclick="copyHealthyConfigs()" id="copyBtn" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-xl text-sm font-medium hidden">Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…</button>
                </div>
                <div id="status" class="text-center text-xs text-slate-500"></div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl">
                    <table class="w-full text-right">
                        <thead class="bg-slate-700/50 text-gray-300 text-xs">
                            <tr>
                                <th class="p-4">Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯</th>
                                <th class="p-4 text-center">Ù¾ÛŒÙ†Ú¯</th>
                                <th class="p-4 text-center">ÙˆØ¶Ø¹ÛŒØª</th>
                            </tr>
                        </thead>
                        <tbody id="resultTable" class="divide-y divide-slate-700">
                            </tbody>
                    </table>
                    <div id="emptyState" class="p-10 text-center text-gray-500 text-sm">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let healthyConfigs = [];

        async function processSub() {
            const btn = document.getElementById('btn');
            const subInput = document.getElementById('subLinks').value.trim();
            const resultsBody = document.getElementById('resultTable');
            const status = document.getElementById('status');
            const pingLimit = parseInt(document.getElementById('pingLimit').value);
            
            if (!subInput) return;
            
            // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
            btn.disabled = true;
            btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
            resultsBody.innerHTML = "";
            healthyConfigs = [];
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('copyBtn').classList.add('hidden');

            const links = subInput.split('\n');

            for (let sub of links) {
                try {
                    status.innerText = "Ø¯Ø±Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ø­ØªÙˆØ§...";
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(sub.trim())}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    
                    let decoded;
                    try { decoded = atob(data.contents.trim()); } catch { decoded = data.contents; }

                    const configs = decoded.split('\n').filter(c => c.includes('://'));
                    
                    for (let conf of configs) {
                        const parsed = parseConfig(conf);
                        if (parsed) {
                            const rowId = `row-${Math.random().toString(36).substr(2, 9)}`;
                            const row = resultsBody.insertRow();
                            row.id = rowId;
                            row.className = "hover:bg-slate-700/30 transition text-sm";
                            row.innerHTML = `
                                <td class="p-4 max-w-[200px] truncate font-medium">${parsed.name}</td>
                                <td class="p-4 text-center font-mono" id="ping-${rowId}">...</td>
                                <td class="p-4 text-center" id="status-${rowId}">â³</td>
                            `;
                            
                            // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
                            performTest(parsed, rowId, conf, pingLimit);
                        }
                    }
                } catch (e) {
                    status.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø§Ø¨â€ŒÙ„ÛŒÙ†Ú©.";
                }
            }
            btn.disabled = false;
            btn.innerText = "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯";
        }

        function parseConfig(url) {
            try {
                let name = "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…", address = "";
                if (url.startsWith('vmess://')) {
                    const data = JSON.parse(atob(url.replace('vmess://', '')));
                    name = data.ps; address = data.add;
                } else {
                    const parts = new URL(url);
                    name = decodeURIComponent(parts.hash.replace('#', '')) || "Config";
                    address = parts.hostname;
                }
                return { name, address };
            } catch { return null; }
        }

        async function performTest(parsed, rowId, fullConfig, limit) {
            const start = Date.now();
            const pingCell = document.getElementById(`ping-${rowId}`);
            const statusCell = document.getElementById(`status-${rowId}`);
            const row = document.getElementById(rowId);

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 4000);

            try {
                // ØªØ³Øª Ù¾ÛŒÙ†Ú¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP Ø¨Ù‡ Ù¾ÙˆØ±Øª 443 Ø³Ø±ÙˆØ±
                await fetch(`https://${parsed.address}`, { mode: 'no-cors', signal: controller.signal });
                const delta = Date.now() - start;
                clearTimeout(timeout);

                pingCell.innerText = delta + "ms";
                
                if (delta <= limit) {
                    pingCell.className = "p-4 text-center font-mono text-emerald-400";
                    statusCell.innerText = "âœ…";
                    healthyConfigs.push(fullConfig);
                    document.getElementById('copyBtn').classList.remove('hidden');
                } else {
                    row.classList.add('opacity-40');
                    pingCell.className = "p-4 text-center font-mono text-amber-400";
                    statusCell.innerText = "ğŸ¢";
                }
            } catch {
                pingCell.innerText = "Timeout";
                pingCell.className = "p-4 text-center font-mono text-red-500";
                statusCell.innerText = "âŒ";
                row.classList.add('opacity-30');
            }
        }

        function copyHealthyConfigs() {
            const text = healthyConfigs.join('\n');
            navigator.clipboard.writeText(text);
            const copyBtn = document.getElementById('copyBtn');
            copyBtn.innerText = "Ú©Ù¾ÛŒ Ø´Ø¯! (ØªØ¹Ø¯Ø§Ø¯: " + healthyConfigs.length + ")";
            setTimeout(() => { copyBtn.innerText = "Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…"; }, 2000);
        }
    </script>
</body>
</html>
