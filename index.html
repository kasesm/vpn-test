<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Sub Checker (Cloudflare Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-4xl mx-auto">
        <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700 shadow-2xl">
            <h1 class="text-2xl font-bold text-blue-400 mb-6 text-center">تستر ساب‌لینک (پروکسی کلادفلیر)</h1>
            
            <textarea id="subLinks" rows="4" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-4 text-sm mb-4 outline-none focus:ring-2 focus:ring-blue-500 font-mono" dir="ltr" placeholder="https://example.com/sub..."></textarea>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">آدرس ورکر کلادفلیر شما:</label>
                    <input type="text" id="workerUrl" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-2 text-xs" dir="ltr" placeholder="https://your-worker.workers.dev">
                </div>
                <div class="flex items-end">
                    <button onclick="startTest()" id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-xl font-bold transition">شروع تست</button>
                </div>
            </div>

            <div id="stats" class="grid grid-cols-3 gap-2 text-center text-xs bg-slate-900/50 p-4 rounded-2xl">
                <div>کل کانفیگ‌ها: <b id="total" class="text-blue-400">0</b></div>
                <div>تست شده: <b id="tested" class="text-yellow-400">0</b></div>
                <div>سالم: <b id="healthy" class="text-green-400">0</b></div>
            </div>
        </div>

        <div class="mt-8 bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden shadow-xl">
            <table class="w-full text-right text-sm">
                <thead class="bg-slate-900/80 text-slate-400">
                    <tr>
                        <th class="p-4">نام کانفیگ</th>
                        <th class="p-4 text-center">پینگ</th>
                        <th class="p-4 text-center">وضعیت</th>
                    </tr>
                </thead>
                <tbody id="resultTable"></tbody>
            </table>
        </div>
        <button onclick="copyAll()" id="copyBtn" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-bold hidden shadow-lg shadow-emerald-900/20">کپی کانفیگ‌های سالم (زیر ۱۰۰۰ میلی‌ثانیه)</button>
    </div>

    <script>
        let healthyConfigs = [];
        let configList = [];
        let testedCount = 0;

        async function startTest() {
            const subUrl = document.getElementById('subLinks').value.trim();
            const workerProxy = document.getElementById('workerUrl').value.trim();
            const btn = document.getElementById('mainBtn');
            const table = document.getElementById('resultTable');

            if (!subUrl || !workerProxy) return alert("لطفاً هم لینک ساب و هم آدرس ورکر را وارد کنید");

            // آماده‌سازی اولیه
            btn.disabled = true;
            btn.innerText = "در حال دریافت ساب...";
            table.innerHTML = "";
            healthyConfigs = [];
            testedCount = 0;

            try {
                // دریافت محتوا از طریق ورکر شما
                const response = await fetch(`${workerProxy}?url=${encodeURIComponent(subUrl)}`);
                const rawData = await response.text();
                
                let decoded = "";
                try {
                    decoded = atob(rawData.trim().replace(/_/g, '/').replace(/-/g, '+'));
                } catch {
                    decoded = rawData;
                }

                configList = decoded.split(/\r?\n/).filter(line => line.includes('://'));
                document.getElementById('total').innerText = configList.length;

                if (configList.length === 0) throw new Error("کانفیگی پیدا نشد");

                for (const conf of configList) {
                    await testOne(conf);
                }

            } catch (err) {
                alert("خطا: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "شروع مجدد";
                if(healthyConfigs.length > 0) document.getElementById('copyBtn').classList.remove('hidden');
            }
        }

        async function testOne(conf) {
            let address = "";
            let name = "Unnamed";

            try {
                if (conf.startsWith('vmess://')) {
                    const json = JSON.parse(atob(conf.replace('vmess://', '')));
                    address = json.add; name = json.ps;
                } else {
                    const parts = new URL(conf);
                    address = parts.hostname;
                    name = decodeURIComponent(conf.split('#')[1] || "Config");
                }

                const row = document.getElementById('resultTable').insertRow();
                const nCell = row.insertCell(0);
                const pCell = row.insertCell(1);
                const sCell = row.insertCell(2);
                
                nCell.className = "p-4 border-b border-slate-700/50 truncate max-w-[200px]";
                pCell.className = "p-4 border-b border-slate-700/50 text-center font-mono";
                sCell.className = "p-4 border-b border-slate-700/50 text-center";
                
                nCell.innerText = name;
                pCell.innerText = "...";
                sCell.innerText = "⏳";

                const start = Date.now();
                try {
                    // تست پینگ مستقیم از مرورگر کاربر به سرور کانفیگ
                    await fetch(`https://${address}`, { mode: 'no-cors', cache: 'no-cache', signal: AbortSignal.timeout(3500) });
                    const delay = Date.now() - start;
                    pCell.innerText = delay + "ms";
                    pCell.className += delay < 600 ? " text-green-400" : " text-yellow-500";
                    sCell.innerText = "✅";
                    healthyConfigs.push(conf);
                } catch {
                    pCell.innerText = "Timeout";
                    pCell.className += " text-red-500 text-xs";
                    sCell.innerText = "❌";
                }
            } catch (e) {
                console.error("خطا در پارس", e);
            } finally {
                testedCount++;
                document.getElementById('tested').innerText = testedCount;
                document.getElementById('healthy').innerText = healthyConfigs.length;
            }
        }

        function copyAll() {
            navigator.clipboard.writeText(healthyConfigs.join('\n'));
            alert("تمام کانفیگ‌های سالم کپی شدند!");
        }
    </script>
</body>
</html>
