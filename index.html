<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Config Pro Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-500 mb-2 text-shadow-lg">تستر هوشمند سابلینک</h1>
            <div id="statsBar" class="flex flex-wrap justify-center gap-3 mt-4 text-xs md:text-sm">
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 shadow-sm">کل: <b id="totalCount" class="text-blue-400">0</b></span>
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 shadow-sm">تست شده: <b id="testedCount" class="text-yellow-400">0</b></span>
                <span class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 shadow-sm text-emerald-400 font-bold">سالم: <b id="healthyCount">0</b></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-2xl">
                    <label class="block text-sm font-medium mb-2 text-blue-300">ورودی سابلینک (هر خط یکی):</label>
                    <textarea id="subLinks" rows="6" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-[10px] md:text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none transition text-left" dir="ltr" placeholder="https://example.com/sub..."></textarea>
                    
                    <div class="mt-4">
                        <label class="block text-xs text-gray-400 mb-1">فیلتر پینگ (ms) کمتر از:</label>
                        <input type="number" id="pingLimit" value="800" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-center font-bold text-blue-400">
                    </div>

                    <button onclick="processSub()" id="btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all transform active:scale-95">شروع فرآیند تست</button>
                    <button onclick="copyHealthyConfigs()" id="copyBtn" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-xl text-sm font-medium hidden shadow-lg shadow-emerald-900/20">کپی کانفیگ‌های سبز (سالم)</button>
                </div>
                <div id="statusInfo" class="text-center text-[11px] text-slate-500 min-h-[1.5rem]"></div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl min-h-[400px]">
                    <div class="max-h-[600px] overflow-y-auto custom-scroll">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-slate-700/80 sticky top-0 backdrop-blur-md text-gray-300 text-xs">
                                <tr>
                                    <th class="p-4">نام کانفیگ</th>
                                    <th class="p-4 text-center">پینگ</th>
                                    <th class="p-4 text-center">وضعیت</th>
                                </tr>
                            </thead>
                            <tbody id="resultTable" class="divide-y divide-slate-700"></tbody>
                        </table>
                        <div id="emptyState" class="p-20 text-center text-gray-500 text-sm italic">لیست کانفیگ‌ها اینجا ظاهر می‌شود...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let healthyConfigs = [];
        let totalFound = 0;
        let testedSoFar = 0;

        async function processSub() {
            const btn = document.getElementById('btn');
            const subInput = document.getElementById('subLinks').value.trim();
            const resultsBody = document.getElementById('resultTable');
            const statusInfo = document.getElementById('statusInfo');
            const pingLimit = parseInt(document.getElementById('pingLimit').value);
            
            if (!subInput) return alert("لطفاً لینک ساب را وارد کنید");
            
            btn.disabled = true;
            btn.innerText = "درحال دریافت محتوا...";
            resultsBody.innerHTML = "";
            healthyConfigs = [];
            totalFound = 0;
            testedSoFar = 0;
            updateStats();
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('copyBtn').classList.add('hidden');

            const links = subInput.split('\n').map(l => l.trim()).filter(l => l !== '');
            const proxies = [
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];

            for (let subUrl of links) {
                let success = false;
                let content = "";

                for (let proxyFn of proxies) {
                    try {
                        statusInfo.innerText = "تلاش برای دریافت از پروکسی واسط...";
                        const res = await fetch(proxyFn(subUrl));
                        const data = await res.json();
                        content = data.contents || data;
                        if (content && content.length > 10) { success = true; break; }
                    } catch (e) { console.log("تغییر پروکسی..."); }
                }

                if (success) {
                    statusInfo.innerText = "محتوا با موفقیت دریافت شد.";
                    handleContent(content, pingLimit, resultsBody);
                } else {
                    statusInfo.innerText = "خطا در دریافت! لینک را چک کنید.";
                }
            }
            btn.disabled = false;
            btn.innerText = "تست مجدد";
        }

        function handleContent(content, limit, container) {
            let decoded = "";
            try {
                decoded = atob(content.replace(/\s/g, '').replace(/-/g, '+').replace(/_/g, '/'));
            } catch {
                decoded = content;
            }

            const configs = decoded.split(/\r?\n/).filter(c => c.includes('://'));
            totalFound += configs.length;
            updateStats();

            configs.forEach(conf => {
                const parsed = parseConfig(conf);
                if (parsed) {
                    const rowId = `row-${Math.random().toString(36).substr(2, 7)}`;
                    const row = container.insertRow();
                    row.id = rowId;
                    row.className = "hover:bg-slate-700/30 transition text-[11px] md:text-sm";
                    row.innerHTML = `<td class="p-4 truncate max-w-[150px] md:max-w-[250px]">${parsed.name}</td><td class="p-4 text-center font-mono" id="ping-${rowId}">---</td><td class="p-4 text-center" id="status-${rowId}">⏳</td>`;
                    performTest(parsed, rowId, conf, limit);
                } else {
                    testedSoFar++; updateStats();
                }
            });
        }

        function parseConfig(url) {
            try {
                let name = "Unknown", address = "";
                if (url.startsWith('vmess://')) {
                    const data = JSON.parse(atob(url.replace('vmess://', '')));
                    name = data.ps; address = data.add;
                } else {
                    const parts = new URL(url);
                    address = parts.hostname || parts.username;
                    name = decodeURIComponent(url.split('#')[1] || "Config");
                }
                return address ? { name, address } : null;
            } catch { return null; }
        }

        async function performTest(parsed, rowId, fullConfig, limit) {
            const start = Date.now();
            const pingCell = document.getElementById(`ping-${rowId}`);
            const statusCell = document.getElementById(`status-${rowId}`);
            
            try {
                const controller = new AbortController();
                const timeout
